<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html { height: 80% ; width: 80%}
        body { height: 80%; margin: 20; padding: 0 }
    </style>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhX-qoDaSbIBYqSykD3_nCE-hZylnfjtU&sensor=false"></script>


     <script type="text/javascript">
  if (Meteor.isClient) {

//Session.set('myLat',-34.397);
//Session.set('myLon',150.644);
Session.set('myLat','?');
Session.set('myLon','?');
Session.set('signUp-visible', false);
Session.set('majOk', false);

function initialize() {
// Je définie les options de ma fonction

  var mapOptions = {
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

// Je créé ma carte

  map = new google.maps.Map(document.getElementById("map-canvas"),
    mapOptions); 

  // Je détermine ma fonction de géolocalisation en HTML5

  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

      var infowindow = new google.maps.InfoWindow({
        map: map,
        position: pos,
        content: 'Je suis ici !'
      });

    var allFoodTrucks = FoodTrucks.find();
    allFoodTrucks.forEach(function (foodTruck) {
      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(foodTruck.lat, foodTruck.lon),
        title: foodTruck.nom,
        postId: foodTruck._id
      });

      marker.setMap(map);
    });  


// Je demande à ce que la carte soit centrée sur ma position

      map.setCenter(pos);
    }, 


// Je détermine comment doit agir la carte si la géolocalisation n'est pas possible

function() {
      handleNoGeolocation(true);
    });
  } else {

    handleNoGeolocation(false);
  }
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Erreur: Le service de géolocalisation ne fonctionne pas.';
  } else {
    var content = 'Erreur: Votre navigateur ne supporte pas la géolocalisation.';
  }
// Si la carte ne me géolocalise pas, elle va se positionner sur les points de latitude et longitude définis ci-dessous

  var options = {
    map: map,
    position: new google.maps.LatLng(44.8333, 0.5667),
    content: content
  };

  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}


google.maps.event.addDomListener(window, 'load', initialize);

    
Template.aFoodTruck.helpers({
  nom: function () {
	Session.set('truckImageUploaded', false);
	Session.set('menuImageUploaded', false);
	Session.set('logoImageUploaded', false);
	myFdTk=FoodTrucks.findOne({truckerId : Meteor.userId()});
	if(myFdTk) {
if (myFdTk.truck) {
if ((myFdTk.truck.path!='') ) {
		Session.set('truckImageUploaded', myFdTk.truck.path);
}
};
if (myFdTk.menu) {
if (myFdTk.menu.path!='') {
		Session.set('menuImageUploaded', myFdTk.menu.path);
}
};
if (myFdTk.logo) {
if (myFdTk.logo.path!='') {
		Session.set('logoImageUploaded', myFdTk.logo.path);
}
};
		Session.set('signUp-visible', true);
		return myFdTk.nom;
	} else {
		Session.set('signUp-visible', false);
		return '';
	}
  },
  
  myId: function () {
	if(myFdTk) {
		return myFdTk._id;
	} else {
		return 0;
	}
  },


  theme: function () {
	if(myFdTk) {
		return myFdTk.theme;
	} else {
		return '';
	}
  },

  description: function () {
	if(myFdTk) {
		return myFdTk.description;
	} else {
		return '';
	}
  },
  
  locationLat: function () {
    if(Session.get('myLat') === '?'){
     console.log('locationlat helpers : avant getlocation');
 getLocation();
      console.log('locationlat helpers : après getlocation');
   }
	console.log('helpers locationLat : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    return Session.get('myLat');
  },
  locationLon: function () {
    if(Session.get('myLon') === '?'){
      console.log('locationlon helpers : avant getlocation');
     getLocation();
      console.log('locationlon helpers : après getlocation');
    }      
	console.log('helpers locationLon : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    return Session.get('myLon');
  },

  logo: function () {
		if(myFdTk) {
			return myFdTk.logo;
		} else {
			return '';
		}
  },
  menu: function () {
		if(myFdTk) {
			return myFdTk.menu;
		} else {
			return '';
		}
  },
  truck: function () {
		if(myFdTk) {
			return myFdTk.truck;
		} else {
			return '';
		}
  },
  truckExist: function () {
		return Session.get('signUp-visible');
 },
  messageOk: function () {
		return Session.get('majOk');
 },
  truckUploaded: function () {
		return Session.get('truckImageUploaded');
 },
  logoUploaded: function () {
		return Session.get('logoImageUploaded');
 },
  menuUploaded: function () {
		return Session.get('menuImageUploaded');
 }

});

Template.myMenu.helpers({
  menuFormData: function () {
   return {prefix: 'Menu', nom: myFdTk.nom, id: myFdTk._id};
  },
   myMenuCallbacks: function() {
        return {
            finished: function(index, fileInfo, context) { 				Session.set('menuImageUploaded', fileInfo.path);
 		}
        }
    }
});

Template.myLogo.helpers({
  logoFormData: function () {
    return {prefix: 'Logo', nom: myFdTk.nom, id: myFdTk._id};
  },
   myLogoCallbacks: function() {
        return {
            finished: function(index, fileInfo, context) { 				Session.set('logoImageUploaded', fileInfo.path);
 		}
        }
    }

});

Template.myTruck.helpers({
  truckFormData: function () {
	  return {prefix: 'Truck', nom: myFdTk.nom, id: myFdTk._id};
  },
   myTruckCallbacks: function() {
        return {
            finished: function(index, fileInfo, context) { 	
			Session.set('truckImageUploaded', fileInfo.path);
 		}
        }
    }
});

    function getLocation() {
	  console.log('dÃ©but getLocation : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
      navigator.geolocation.watchPosition(success, error, options);    
	  console.log('fin getLocation : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    }

  
  function success(position) {
  Session.set('myLat', position.coords.latitude);
  Session.set('myLon', position.coords.longitude);
  console.log('success : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    console.log('set my coords done...');
    console.log('success : call rendered');
  }
    
function error(err) {
  console.warn('ERROR(' + err.code + '): ' + err.message);
};
    
options = {
  enableHighAccuracy: false,
  timeout: 360000,
  maximumAge: 0
};

  Template.truckerboard.helpers({
    foodtruckers: function () {
      return FoodTrucks.find({}, { sort: { nom: 1 } });
    }
  });
}
      </script>
</head>
<body onload="initialize()">
 <div class="navbar navbar-inverse navbar-fixed-top">
       <div class="navbar-inner">
         <div class="container">
           <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">

           </button>
           <a class="brand" href="#">My food truck</a>
         </div>
       </div>
     </div>


     <div class="container">
       <br><br>
       <p>
       {{#if currentUser}}
			{{> loginButtons}}
			{{> aFoodTruck}}
		{{else}}
		  <h5>Truckers : Connectez-vous pour enregistrer la position de votre foodtruck</h5>
			{{> loginButtons}}
			{{> truckerboard}}
         {{/if}}
       </p>
    </div>
{{> mapPostsList}}


</body>

<template name="aFoodTruck">

    <h2>Bienvenue</h2>
    <form>
        <label>Nom :</label><input type="text" name="nom" value={{nom}}><br />
        <label>ThÃ¨me :</label><input type="text" name="theme" value={{theme}}><br />
        <label>Description</label><textarea name="description" value={{description}}></textarea><br />
		<label>Mon emplacement actuel :</label>
		<div>
        <label>Lat :</label><textarea name="locationLat" value={{locationLat}}></textarea><br />
		</div>
		<div>
        <label>Lon :</label><textarea name="locationLon" value={{locationLon}}></textarea><br />
		</div>        
  <button type="submit" >Enregistrer</button>
      </form>
{{#with messageOk}}
<label>Modification effectuÃ©e</label>
{{/with}}

<p>Vous pouvez prendre des photos de votre camion, de votre logo et de votre menu et les ajouter ici</p>

{{#with truckExist }}
<div id="listImages">
			{{> myTruck}}
	{{#with truckUploaded}}
	<label>Mon camion :</label>
<img src="/upload{{truckUploaded}}" width=30% height=30%>
	{{/with}}
<br/>
			{{> myLogo}}
	{{#with logoUploaded}}
	<label>Mon logo :</label>
	<img src="/upload{{logoUploaded}}" width=30% height=30%>	{{/with}}
<br/>
			{{> myMenu}}
	{{#with menuUploaded}}
	<label>Mon menu :</label>
	<img src="/upload{{menuUploaded}}" width=30% height=30%>	{{/with}}
<br/>
</div>
{{/with}}
</template>



<template name="myMenu">
		<div>
			Menu: {{> upload_bootstrap contentType='images' fileTypes='.gif, .bmp, .png, .jpg' formData=menuFormData callbacks=myMenuCallbacks}}
		</div>  
</template>

<template name="myLogo">
		<div>
			Logo: {{> upload_bootstrap contentType='images' fileTypes='.gif, .bmp, .png, .jpg' formData=logoFormData callbacks=myLogoCallbacks}}
		</div>  
</template>

<template name="myTruck">
		<div>
			Camion: {{> upload_bootstrap contentType='images' fileTypes='.gif, .bmp, .png, .jpg' formData=truckFormData callbacks=myTruckCallbacks}}
		</div>  
</template>



<template name="truckerboard">
    <h3>Liste des foodtruckers inscrits</h3>
	<div>
    <ul>
    {{#each foodtruckers}}
        <li><b>{{ nom }}</b>  <em>{{ theme }}</em> <p> {{ description }} </p>  
       {{#if truck.path}}
		<img src="/upload{{truck.path}}" class="thumb">
       {{/if}}
       {{#if logo.path}}
		<img src="/upload{{logo.path}}" class="thumb">
       {{/if}}
	  {{#if menu.path}}
		<img src="/upload{{menu.path}}" class="thumb">
	  {{/if}}
		</li>
<br/>
<br/>
<br/>
<br/>
<br/>
    {{/each}}
    </ul>
	</div>
</template>

<template name="mapPostsList">
  <div id="map">
    <div id="map-canvas"></div>
  </div>
</template>




