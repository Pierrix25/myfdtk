<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html { height: 80% ; width: 80%}
        body { height: 80%; margin: 20; padding: 0 }
    </style>

     <script type="text/javascript">
  if (Meteor.isClient) {
    
//Session.set('myLat',-34.397);
//Session.set('myLon',150.644);
Session.set('myLat','?');
Session.set('myLon','?');
    
    
Template.location.helpers({
  locationLat: function () {
    if(Session.get('myLat') === '?'){
      getLocation();
    }
	console.log('helpers locationLat : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    return Session.get('myLat');
  },
  locationLon: function () {
    if(Session.get('myLon') === '?'){
      getLocation();
    }      
	console.log('helpers locationLon : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    return Session.get('myLon');
  }
});

Template.aFoodTruck.helpers({
  nom: function () {
	myFdTk=FoodTrucks.findOne({truckerId : Meteor.userId()});
	if(myFdTk) {
		return myFdTk.nom;
	} else {
		return '';
	}
  },

  theme: function () {
	if(myFdTk) {
		return myFdTk.theme;
	} else {
		return '';
	}
  },

  description: function () {
	if(myFdTk) {
		return myFdTk.description;
	} else {
		return '';
	}
  },
  
  locationLat: function () {
    return Session.get('myLat');
  },
  locationLon: function () {
    return Session.get('myLon');
  }
});
    function getLocation() {
	  console.log('début getLocation : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
      navigator.geolocation.watchPosition(success, error, options);    
	  console.log('fin getLocation : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    }

  
  function success(position) {
  Session.set('myLat', position.coords.latitude);
  Session.set('myLon', position.coords.longitude);
  console.log('success : myLat=' + Session.get('myLat') + ' myLon=' + Session.get('myLon'));
    console.log('set my coords done...');
  }
    
function error(err) {
  console.warn('ERROR(' + err.code + '): ' + err.message);
};
    
options = {
  enableHighAccuracy: false,
  timeout: 120000,
  maximumAge: 0
};

  Template.truckerboard.helpers({
    foodtruckers: function () {
      return FoodTrucks.find({}, { sort: { nom: 1 } });
    }
  });
}
      </script>
</head>
<body>
 <div class="navbar navbar-inverse navbar-fixed-top">
       <div class="navbar-inner">
         <div class="container">
           <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">

           </button>
           <a class="brand" href="#">My food truck</a>
         </div>
       </div>
     </div>
     <div class="container">
       <BR/><BR/>
       <p>
       {{#if currentUser}}
			{{> aFoodTruck}}
		{{else}}
		<h1>Votre emplacement actuel :</h1>
			{{> location}}
         {{/if}}
       </p>
    </div>

	{{> truckerboard}}
       <h5>Truckers : Connectez-vous pour enregistrer la position de votre foodtruck</h5>
       <p>{{> loginButtons}}</p>
</body>

<template name="aFoodTruck">

    <h2>Bienvenue</h2>
    <form>
        <label>Nom :</label><input type="text" name="nom" value={{nom}}><br />
        <label>Thème :</label><input type="text" name="theme" value={{theme}}><br />
        <label>Description</label><textarea name="description" value={{description}}></textarea><br />
		<label>Mon emplacement actuel :</label>
		<div>
			Lat: {{locationLat}}
		</div>
		<div>
			Lon: {{locationLon}}
		</div>        
  <button type="submit" >Enregistrer</button>
    </form>
</template>


<template name="location">
  <div>
    Lat: {{locationLat}}
  </div>
  <div>
    Lon: {{locationLon}}
  </div>
</template>

<template name="truckerboard">
    <h3>Liste des foodtruckers inscrits</h3>
    <ul>
    {{#each foodtruckers}}
        <li><b>{{ nom }}</b>,  <em>{{ theme }}</em> <p> {{ description }} </p> 
		<p>situé : lon {{ lon  }} lat {{ lat }}</p>
		</li>
    {{/each}}
    </ul>
</template>



